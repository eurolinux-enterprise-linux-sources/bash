From 16fabec0bab2a38d37e14d6297b7ba3401b7e927 Mon Sep 17 00:00:00 2001
From: Kamil Dudka <kdudka@redhat.com>
Date: Wed, 10 Jun 2015 11:03:41 +0200
Subject: [PATCH 1/2] termsig_sighandler: inhibit writing rl history

Bug: https://bugzilla.redhat.com/868846
Upstream-commit:
http://git.savannah.gnu.org/cgit/bash.git/diff/sig.c?id=495aee44
---
 sig.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/sig.c b/sig.c
index 459ffb3..29fe9e2 100644
--- a/sig.c
+++ b/sig.c
@@ -59,6 +59,9 @@ extern int loop_level, continuing, breaking;
 extern int executing_list;
 extern int comsub_ignore_return;
 extern int parse_and_execute_level, shell_initialized;
+#if defined (HISTORY)
+extern int history_lines_this_session;
+#endif
 
 /* Non-zero after SIGINT. */
 volatile int interrupt_state = 0;
@@ -495,6 +498,10 @@ termsig_sighandler (sig)
   /* XXX - should this also trigger when interrupt_immediately is set? */
   if (terminate_immediately)
     {
+#if defined (HISTORY)
+      /* XXX - will inhibit history file being written */
+      history_lines_this_session = 0;
+#endif
       terminate_immediately = 0;
       termsig_handler (sig);
     }
-- 
2.4.2


From 7c154d9601ad694675a331f18ddf00bcdd351994 Mon Sep 17 00:00:00 2001
From: Chet Ramey <chet.ramey@case.edu>
Date: Tue, 22 Nov 2011 20:00:47 -0500
Subject: [PATCH 2/2] Bash-4.2 patch 8

Bug: https://lists.gnu.org/archive/html/bug-bash/2011-03/msg00073.html
Upstream-commit: d5d0096115d0d484fd669ad170498962ea45e841
Signed-off-by: Kamil Dudka <kdudka@redhat.com>
---
 sig.c | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/sig.c b/sig.c
index 29fe9e2..27952b6 100644
--- a/sig.c
+++ b/sig.c
@@ -46,6 +46,7 @@
 
 #if defined (READLINE)
 #  include "bashline.h"
+#  include <readline/readline.h>
 #endif
 
 #if defined (HISTORY)
@@ -62,6 +63,7 @@ extern int parse_and_execute_level, shell_initialized;
 #if defined (HISTORY)
 extern int history_lines_this_session;
 #endif
+extern int no_line_editing;
 
 /* Non-zero after SIGINT. */
 volatile int interrupt_state = 0;
@@ -500,7 +502,10 @@ termsig_sighandler (sig)
     {
 #if defined (HISTORY)
       /* XXX - will inhibit history file being written */
-      history_lines_this_session = 0;
+#  if defined (READLINE)
+      if (interactive_shell == 0 || interactive == 0 || (sig != SIGHUP && sig != SIGTERM) || no_line_editing || (RL_ISSTATE (RL_STATE_READCMD) == 0))
+#  endif
+        history_lines_this_session = 0;
 #endif
       terminate_immediately = 0;
       termsig_handler (sig);
-- 
2.4.2

